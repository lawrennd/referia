---
author: "Neil D. Lawrence"
created: "2025-12-21"
id: "0007"
last_updated: "2025-12-21"
status: proposed
design_revision: "Changed from boolean append parameter to tri-state mode parameter"
tags:
- cip
- compute
- ui
- enhancement
title: "Append Mode for Compute Operations"
---

# CIP-0007: Append Mode for Compute Operations

## Summary

Add support for compute operations to append their results to existing field values rather than always replacing them. This enables building conversation histories and accumulating multiple analyses without losing previous results.

## Motivation

Currently, all compute operations in referia/lynguine replace the target field's value. This creates several limitations:

1. **Lost Context**: When using `llm_custom_query` multiple times on the same field, previous queries and responses are lost
2. **No Conversation History**: Users cannot build up a dialogue with the LLM about a particular section
3. **Manual Workarounds**: Users must manually copy/paste previous content to preserve it
4. **Poor UX for Iterative Analysis**: The system doesn't naturally support the common workflow of asking follow-up questions

**Use Case Example:**

A document reviewer wants to ask multiple questions about a document:
1. First query: "What are the main contributions?"
2. Second query: "How does this relate to prior work?"
3. Third query: "What are the limitations?"

With current behavior, each query overwrites the previous one. With append mode, all Q&A pairs would accumulate in the field, creating a comprehensive analysis history.

## Detailed Description

### Design Rationale: Why `mode` Parameter?

The initial design considered a boolean `append: true/false` parameter, but this was revised to use a tri-state `mode` parameter with values `"replace"`, `"append"`, and `"prepend"` for several reasons:

1. **Extensibility**: A mode parameter can easily support additional write strategies in the future (e.g., "merge", "insert-at", "accumulate-unique") without API changes
2. **Clarity**: `mode: "append"` is more self-documenting than `append: true`
3. **Symmetry**: Supporting both append and prepend is natural with mode values, while `append: "before"` would be semantically confusing
4. **Common Pattern**: Many systems use mode/strategy parameters (e.g., file open modes: "r", "w", "a")
5. **Single Responsibility**: One parameter controls the write strategy rather than multiple boolean flags

### Core Mechanism

Add a `mode` parameter to the compute configuration that controls how results are written to the target field:

```yaml
- type: PopulateButton
  args:
    target: ch1CustomResponse
    compute:
      field: ch1CustomResponse
      function: llm_custom_query
      mode: "append"  # New parameter: "append" | "prepend" | "replace"
      separator: "\n\n---\n\n"  # Optional separator between entries
      # ... other args
```

### Write Modes

**`mode: "replace"`** (default, current behavior):
- Replace target field value with new content
- If omitted, defaults to "replace" for backward compatibility

**`mode: "append"`**:
1. Read current value of target field
2. If non-empty, append separator (default: `"\n\n---\n\n"`)
3. Append new content from compute function
4. Write combined value back to target field

**`mode: "prepend"`**:
1. Read current value of target field
2. Prepend new content before existing content
3. If existing content is non-empty, insert separator after new content
4. Write combined value back to target field

### Separator Options

The separator between entries should be configurable:
- Default: `"\n\n---\n\n"` (markdown horizontal rule with spacing)
- Custom: any string value
- Empty string: `""` for direct concatenation
- Used for both append and prepend modes

### Entry Metadata (Optional Enhancement)

Consider adding optional metadata to each appended entry:
```
[2025-12-21 14:30:15]
**Question:** What are the main contributions?

**Response:** The chapter presents three main contributions...
```

This could be controlled by an `include_metadata` flag.

## Implementation Plan

### Phase 1: Core Write Mode Functionality
1. **Modify Compute System**:
   - Add `mode` parameter to compute configuration schema (values: "replace", "append", "prepend")
   - Add `separator` parameter with default value
   - Update compute execution to check mode parameter
   - Implement append logic (read → concatenate → write)
   - Implement prepend logic (read → concatenate → write)

2. **Update Data Access Layer**:
   - Ensure field reading works correctly with Excel, YAML, and other backends
   - Handle empty/null field values appropriately
   - Test with different data types (string, text, etc.)

### Phase 2: LLM Query Enhancement
1. **Add `include_query` Parameter**:
   - Modify `llm_custom_query` function signature
   - Add logic to read query from `custom_prompt` field
   - Format output with question and response sections
   - Default to `false` for backward compatibility

2. **Format Template**:
   ```python
   if include_query:
       output = f"**Question:** {query}\n\n**Response:** {response}"
   else:
       output = response
   ```

### Phase 3: UI/UX Updates
1. **Update Placeholder Text**:
   - Change placeholders for append-mode fields
   - Example: "Questions and responses will accumulate here..."

2. **Visual Feedback**:
   - Consider adding a "Clear" button for append-mode fields
   - Show entry count or character count for long accumulated content

### Phase 4: Documentation
1. **Update Configuration Documentation**:
   - Document `append` parameter
   - Document `separator` parameter
   - Provide examples of append mode usage

2. **User Guide**:
   - Explain append mode workflow
   - Show examples of building conversation histories
   - Document best practices

## Backward Compatibility

**Excellent backward compatibility:**
- Default behavior unchanged (mode defaults to "replace")
- New parameters are optional
- Existing configurations work without modification
- No breaking changes to API or data formats

**Migration Path:**
Users who want append or prepend mode must:
1. Add `mode: "append"` or `mode: "prepend"` to their compute configurations
2. Optionally add `include_query: true` to `llm_custom_query` calls
3. Optionally customize `separator` if default is not suitable
4. Update placeholders to reflect new behavior

## Testing Strategy

### Unit Tests
1. **Write Mode Logic**:
   - Test replace mode (default behavior)
   - Test append to empty field
   - Test append to non-empty field
   - Test prepend to empty field
   - Test prepend to non-empty field
   - Test separator insertion for append
   - Test separator insertion for prepend
   - Test with various separator values (including empty string)
   - Test with no mode specified (should default to replace)

2. **LLM Query Formatting**:
   - Test `include_query: true`
   - Test `include_query: false`
   - Test with empty query
   - Test query reading from various field types

### Integration Tests
1. **End-to-End Workflow**:
   - Create test thesis review configuration
   - Execute multiple queries with append mode
   - Execute multiple queries with prepend mode
   - Verify accumulated content in output Excel file
   - Test UI rendering of accumulated content
   - Verify ordering of entries (newest last for append, newest first for prepend)

2. **Backend Compatibility**:
   - Test with Excel output backend
   - Test with YAML output backend
   - Test with other data backends

3. **Edge Cases**:
   - Very long accumulated content (performance)
   - Special characters in content
   - Unicode handling in separators
   - Concurrent appends (if applicable)

### Manual Testing
1. **User Workflow**:
   - Test thesis review workflow with multiple queries
   - Verify UX feels natural
   - Test "Clear" functionality (if implemented)
   - Verify Excel export formatting

## Related Requirements

This CIP addresses user needs for:
- Iterative analysis workflows
- Preserving analysis history
- Building comprehensive reviews through multiple LLM interactions
- Reducing manual copy/paste operations

Specifically supports:
- Thesis examination workflows where examiners ask multiple questions about each chapter
- Research workflows where users refine queries based on previous answers
- Collaborative review processes where multiple analyses are accumulated

## Implementation Status
- [ ] Design write mode mechanism in compute system
- [ ] Implement `mode` parameter in compute configuration ("replace", "append", "prepend")
- [ ] Implement `separator` parameter
- [ ] Implement replace mode logic (existing behavior as default)
- [ ] Implement append mode logic
- [ ] Implement prepend mode logic
- [ ] Add `include_query` flag to `llm_custom_query`
- [ ] Update data access layer for mode-based write operations
- [ ] Add unit tests for all write modes
- [ ] Add integration tests
- [ ] Update thesis review templates to use append mode
- [ ] Update documentation
- [ ] User acceptance testing

## References
- Related to thesis review workflow in `theses/examined/introduction/_referia.yml`
- Affects `llm_custom_query` function in lynguine
- Impacts compute system architecture in referia/lynguine core
- Related to PopulateButton UI component

## Future Enhancements
Consider in future CIPs:
- **Additional write modes**: 
  - `"merge"`: Intelligent merging of structured data
  - `"insert-at-line"`: Insert at specific line number
  - `"accumulate-unique"`: Only append if not already present
- **Entry numbering**: Automatic numbering of accumulated entries
- **Timestamps**: Automatic timestamp on each entry
- **Entry deletion**: UI for removing specific entries
- **Search within entries**: Find specific Q&A pairs in accumulated content
- **Export individual entries**: Extract specific entries for separate use

