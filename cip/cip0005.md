 ---
author: "lawrennd"
created: "2025-10-10"
id: "0005"
last_updated: "2025-10-10"
status: proposed
tags:
- cip
- mapping
- initialization
- lynguine-integration
title: "Fix Mapping Initialization Timing Conflict with lynguine"
---

# CIP-0005: Fix Mapping Initialization Timing Conflict with lynguine

## Summary

Referia's `CustomDataFrame.__init__` creates column-to-variable mappings immediately upon construction, which conflicts with lynguine's flow-based mapping system. This creates non-intuitive behavior where users can't predict when mappings will exist and causes timing conflicts when explicit interface mappings try to override auto-generated identity mappings.

## Motivation

### Current Problem

Referia's `CustomDataFrame` (which inherits from lynguine's) calls `_augment_column_names()` in its `__init__` method (line 180 in `referia/assess/data.py`). This creates identity mappings like `job_title -> job_title` immediately upon construction.

However, when `from_flow()` is called later, it tries to apply explicit interface mappings like `jobTitle: job_title`, which conflicts with the existing identity mappings.

### User Experience Issues

1. **Unexpected Mappings**: Users don't expect mappings to exist after simple construction
2. **Inconsistent Behavior**: Same code behaves differently in referia vs lynguine
3. **Hidden Override Behavior**: Mappings disappear without user knowledge
4. **Unpredictable State**: Users can't predict when mappings will exist without implementation knowledge

### Examples of Confusing Behavior

```python
# User creates data
data = pd.DataFrame({'job_title': ['Engineer'], 'name': ['Alice']})

# lynguine behavior (intuitive)
cdf1 = CustomDataFrame(data=data)
print(cdf1._name_column_map)  # {} - empty as expected

# referia behavior (confusing)
cdf2 = CustomDataFrame(data=data)
cdf2._augment_column_names(data)  # referia does this in __init__
print(cdf2._name_column_map)  # {'job_title': 'job_title', 'name': 'name'} - unexpected!
```

## Detailed Description

### Root Cause

The issue stems from referia's need for early mapping availability (for user-facing review workflows) conflicting with lynguine's flow-based processing model:

- **lynguine**: Mappings created during `from_flow()` processing (predictable)
- **referia**: Mappings created in `__init__` (unpredictable timing)

### Current Workaround

We've implemented a fix in lynguine's `update_name_column_map()` method that allows explicit interface mappings to override auto-generated identity mappings. However, this is a symptom fix rather than addressing the root architectural issue.

### Proposed Solution

Move the `_augment_column_names()` call from referia's `__init__` to a `from_flow()` override, so explicit interface mappings are applied before augmentation:

```python
# In referia's CustomDataFrame
@classmethod
def from_flow(cls, interface):
    # Call parent from_flow (applies explicit interface mappings first)
    cdf = super().from_flow(interface)
    # Now augment mappings for any columns that don't have explicit mappings
    for typ in cdf._d:
        cdf._augment_column_names(cdf._d[typ])
    return cdf
```

## Implementation Plan

### Phase 1: Move augmentation to from_flow (Low risk)
- [ ] Remove `_augment_column_names` call from referia's `__init__` (lines 178-180)
- [ ] Override `from_flow()` in referia to call `_augment_column_names()` after parent completes
- [ ] Run existing referia test suite
- [ ] Verify mappings are available after `from_flow` completes

### Phase 2: Verify no regressions (Medium risk)
- [ ] Test that explicit interface mappings take precedence
- [ ] Ensure identity mapping override fix is still needed (it should be)
- [ ] Check review workflows still have access to mappings when needed
- [ ] Verify computed index columns work correctly

### Phase 3: Documentation (Low risk)
- [ ] Document that referia provides eager mapping creation as application-specific convenience
- [ ] Explain timing: explicit mappings applied before augmentation
- [ ] Note this is why identity mapping override is necessary

## Backward Compatibility

**For referia users:**
- No observable changes in behavior
- Mappings still available after `from_flow()`
- Internal timing improved (explicit mappings take precedence)
- Fix reduces likelihood of future mapping conflicts

## Testing Strategy

1. Verify existing test (`test_identity_mapping_referia.py`) still passes
2. Add test for referia's `from_flow()` override
3. Test that explicit interface mappings take precedence over identity mappings created in `__init__`
4. Verify computed index columns (like `Name` from liquid templates) work correctly
5. Run full referia test suite

## Related Requirements

This CIP addresses the following requirements:

- **User Experience**: Predictable behavior when creating CustomDataFrame instances
- **Architecture**: Clear separation between infrastructure (lynguine) and application (referia) concerns
- **Maintainability**: Reduce hidden complexity and implementation knowledge requirements

Specifically, it implements solutions for:
- Consistent mapping behavior between lynguine and referia
- Predictable timing of mapping creation
- Clear user expectations about when mappings will exist

## Implementation Status

**Status: NOT IMPLEMENTED - Workaround in place**

A workaround has been implemented instead of the proper fix described in this CIP:

**Current Workaround** (referia/assess/data.py lines 210-238):
- Override `update_name_column_map()` to allow overwriting "default mappings"
- Uses `_is_default_mapping()` helper to identify identity and camelCase mappings
- Maintains strict behavior for non-default mappings

**Proper Fix (NOT implemented)**:
- [ ] Phase 1: Move augmentation to from_flow in referia
- [ ] Phase 2: Verify no regressions
- [ ] Phase 3: Documentation

**Timing Issue Remains**: referia still calls `_augment_column_names()` in `__init__` (line 180), so mappings are created early. The workaround allows explicit interface mappings to override these early mappings, but the architectural timing issue described in this CIP is not resolved.

**Status**: Deferred. Workaround is functional; proper architectural fix remains unimplemented.

## References

- Related lynguine CIP: `lynguine/cip/cip0003.md`
- Bug report: `backlog/bugs/2025-10-09_mapping-conflict-with-identity-mappings.md`
- Investigation: `backlog/infrastructure/2025-10-09_investigate-mapping-test-failure.md`
- Current fix: `lynguine/lynguine/assess/data.py` line 3071

